Ad Hoc
======

Das AdHoc System der UV-Webcommunity stellt eine Web-Schnittstelle
für den Kunden/Versicherten bereit, die es Ihm ermöglicht Dokumente die er auf 
postalischen Weg erhält, online an die BG zu versenden.

Dieses System läuft technisch gesehen unter der UVCSite, allerdings wird
ein neuer BrowserLayer dafür definiert. (localhost:8080/++skin++adhoc/app)

Die AdHoc Benutzer arbeiten in der gleichen Site wie normale Benutzer,
Ziel ist es im HomeFolder der Unternehmen einen ProductFolder ADHoc
zu erstellen. In diesem Ordner werden dann die ADHocDokumente abgelegt.

Über den BrowserLayer IAdHocLayer steuern wir die Unterschiedlichen
IndexSeiten etc...

:Test-Layer: functional

Setup
-----

  >>> import grok
  >>> from uvcsite.app import Uvcsite 
  >>> from zope.component.hooks import setSite
  >>> root = getRootFolder()

  >>> root['adhoc'] = app = Uvcsite()
  >>> app
  <uvcsite.app.Uvcsite object at ...>

  >>> setSite(app)

  >>> from zope.component import getMultiAdapter
  >>> from zope.interface import alsoProvides
  >>> from zope.publisher.browser import TestRequest
  >>> from uvcsite.adhoc import IAdHocLayer

Unterschiedliche Indexseiten pro Layer
--------------------------------------

  >>> request = TestRequest()
  >>> uvcsite_view = getMultiAdapter((app, request), name="index")
  >>> uvcsite_view
  <uvcsite.tests.views.Index object at ...>
 
Wir markieren den Request mit unserem Layer...

  >>> adhoc_request = TestRequest()
  >>> alsoProvides(adhoc_request, IAdHocLayer)

  >>> adhoc_view = getMultiAdapter((app, adhoc_request), name="index")
  >>> adhoc_view
  <uvcsite.tests.adhoc.Index object at ...>

  >>> adhoc_view is uvcsite_view
  False


Unterschiedliche Menus pro Layer
--------------------------------

  >>> from zope.viewlet.interfaces import IContentProvider

  >>> uvc_gm = getMultiAdapter((app, request, uvcsite_view), IContentProvider, name="uvc.global.menu")
  >>> uvc_gm
  <uvc.layout.menus.GlobalMenu object at ...>

  >>> adhoc_gm = getMultiAdapter((app, adhoc_request, adhoc_view), IContentProvider, name="uvc.global.menu")
  >>> adhoc_gm
  <uvcsite.adhoc.menus.ADHocGlobalMenu object at ...>

  >>> adhoc_gm is uvc_gm
  False


Event für AdHocUsers
--------------------
Normalerweise müssen wir diesen Adapter für uns
überschreiben und zusätzlich Methoden befüllen.

  >>> from uvcsite.adhoc.adapter import AdHocUserInfo

  >>> class MyAdHocUserInfo(AdHocUserInfo):
  ...     @property
  ...     def isAdHocUser(self):
  ...         if self.context.title.startswith('A'):
  ...             return 1 
  ...         return 0 
  ...
  ...     @property
  ...     def addurl(self):
  ...         return "wiederaufnahme"
  ...
  ...     @property
  ...     def info(self):
  ...         return "Wiederaufnahme der Arbeit"
  ...
  ...     @property
  ...     def defaults(self):
  ...         return {'title': 'Wiederaufnahme'} 

  >>> from grokcore.component.testing import grok_component
  >>> grok_component('MyAdHocUserInfo', MyAdHocUserInfo)
  True


  >>> from zope.pluggableauth.factories import PrincipalInfo, AuthenticatedPrincipalFactory
  >>> request = TestRequest()

  >>> class Authenticator(object):
  ...     prefix = ""
  ...     def getAuthenticatorPlugins(self):
  ...         return []

  >>> adp = PrincipalInfo('0101010001', 'A88889999', 'A88889999', 'A88889999')
  >>> adp
  PrincipalInfo('0101010001')

  >>> adp = AuthenticatedPrincipalFactory(adp, request)(Authenticator())

  >>> adp.id
  '0101010001'

  >>> adp.title
  'A88889999'

  >>> from uvcsite.adhoc.interfaces import IAdHocPrincipal
  >>> IAdHocPrincipal.providedBy(adp)
  True

  >>> p = PrincipalInfo('0101010001', '0101010001', '0101010001', '0101010001')
  >>> p = AuthenticatedPrincipalFactory(p, request)(Authenticator())
  >>> IAdHocPrincipal.providedBy(p)
  False 

  >>> p.groups
  ['zope.Everybody', 'zope.Authenticated', 'uvc.Member']


Homefolder

  >>> from zope.app.homefolder.interfaces import IHomeFolder
  >>> homefolder_adp = IHomeFolder(adp).homeFolder
  >>> 'adhoc' in homefolder_adp
  False

  >>> from dolmen.authentication import UserLoginEvent
  >>> grok.notify(UserLoginEvent(adp))

  >>> 'adhoc' in homefolder_adp
  True 

  >>> homefolder_adp['adhoc']
  <uvcsite.adhoc.components.AdHocFolder object at ...>
 

Adapter für AddHocUser
----------------------

isAdHocUser

  >>> from uvcsite.adhoc.interfaces import IAdHocUserInfo
  >>> ahui = IAdHocUserInfo(adp)

  >>> ahui
  <uvcsite.MyAdHocUserInfo object at ...>

Zunächst müssen wir diesen Adapter Implementieren...

  >>> ahui.isAdHocUser
  1 

  >>> ahui = IAdHocUserInfo(p)
  >>> ahui
  <uvcsite.MyAdHocUserInfo object at ...>

  >>> ahui.isAdHocUser
  0 

  >>> ahui = IAdHocUserInfo(adp)
  >>> ahui
  <uvcsite.MyAdHocUserInfo object at ...>


getAddableObject

  >>> ahui.addurl
  'wiederaufnahme'

  >>> ahui.info
  'Wiederaufnahme der Arbeit'

  >>> ahui.defaults
  {'title': 'Wiederaufnahme'}
