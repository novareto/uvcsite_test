Do a functional doctest test on the app.
========================================

:Test-Layer: functional

Zuerst erstellen wir unsere UVCSite:

   >>> from uvcsite.app import Uvcsite
   >>> from zope.app.component.hooks import setSite
   >>> root = getRootFolder()
   >>> uvcsite = Uvcsite()
   >>> root['app'] = uvcsite
   >>> setSite(uvcsite)

Prüfen wir ob unsere Seite auch das richtige Interface inne hat

   >>> from uvcsite.interfaces import IUVCSite
   >>> IUVCSite.providedBy(root['app'])
   True
 
Instanzieren wir unseren Contenttyp:

   >>> from uvcsite.content.person import Person
   >>> person = Person()
   >>> from uvcsite.content.interfaces import IPerson
   >>> IPerson.providedBy(person)
   True

   >>> root['app']['klaus'] = person


Nachdem wir das Basissetup fertiggestellt haben können wir nun
die Security dieses Objecttypes testen

   >>> from zope.testbrowser.testing import Browser
   >>> browser = Browser()
   >>> url = "http://localhost/++skin++uvcsiteskin/app/"
   >>> #browser.addHeader('Authorization', 'Basic personadd:personadd')
   >>> browser.handleErrors = False 

   >>> browser.open(url+'personadd')
   Traceback (most recent call last):
   ...
   Unauthorized: (<uvcsite.content.person.PersonAdd object at ...>, 'browserDefault', 'uvc.CanAddKontakt') 

Wenn wir uns nun mit einem User anmelden der die Richtigen Rechte hat...

   >>> browser = Browser()
   >>> browser.handleErrors = False 
   >>> browser.addHeader('Authorization', 'Basic mgr:mgrpw')
   >>> browser.open(url+'personadd')
   >>> browser.headers.get('Status').upper()
   '200 OK'

   >>> browser.getControl(name='form.vorname').value = "Christian"
   >>> browser.getControl(name='form.name').value = "klinger"
   >>> browser.getControl(name='form.actions.anlegen').click()

Nachdem wir die Form ausgefüllt und abgeschickt haben sollten wir die Person-Instanz
in unserem HomeFolder finden.

   >>> setSite(uvcsite)
   >>> from zope.component import getUtility
   >>> from zope.app.homefolder.interfaces import IHomeFolderManager
   >>> utility = getUtility(IHomeFolderManager)
   >>> utility
   <uvcsite.homefolder.homefolder.PortalMembership object at ...>

   >>> utility.getHomeFolder('uvc.personadd')
   <uvcsite.homefolder.homefolder.HomeFolder object at ...>
   >>> hf = utility.getHomeFolder('uvc.personadd')
   >>> len(hf)
   1
   >>> [x for x in hf]
   [u'klinger-0']

   >>> person = hf[u'klinger-0']
   >>> person
   <uvcsite.content.person.Person object at ...>

Nun könnnen wir prüfen welche Principlas auf das Object zugreifen dürfen...

   >>> from zope.securitypolicy.interfaces import IPrincipalPermissionManager
   >>> permission_man = IPrincipalPermissionManager(person)
   >>> permission_man.getPermissionsForPrincipal('uvc.personadd')
   [('uvc.CanEditKontakt', PermissionSetting: Allow), ('uvc.CanViewKontakt', PermissionSetting: Allow)]

